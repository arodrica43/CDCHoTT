{-# OPTIONS --cubical --rewriting #-}

module CDCHoTT.Experimental.SDG where

open import Cubical.Foundations.Everything
open import Cubical.Data.Prod.Base


open import Cubical.Data.Int renaming (_+_ to _+â€²_
                                      ; -_ to -â€²_)

open import Cubical.Data.Nat public  renaming (_+_ to _+â€³_)
open import Cubical.Data.Nat.Order                                                                         


postulate
  Line : Set
  _+_ : Line â†’ Line â†’ Line
  _*_ : Line â†’ Line â†’ Line
  -_ : Line â†’ Line
  0' : Line
  1' : Line

infixl 7 _*_
infixl 6 _+_

postulate
  +-identityË¡ : âˆ€ x â†’ 0' + x â‰¡ x 
  +-identityÊ³ : âˆ€ x â†’ x + 0' â‰¡ x
  +-associat : âˆ€ x y z â†’ x + (y + z) â‰¡ x + y + z
  neg-inverseË¡ : âˆ€ x â†’ (- x) + x â‰¡ 0'
  neg-inverseÊ³ : âˆ€ x â†’ x + (- x) â‰¡ 0'
  +-commut : âˆ€ x y â†’ x + y â‰¡ y + x
  *-identityË¡ : âˆ€ x â†’ 1' * x â‰¡ x
  *-identityÊ³ : âˆ€ x â†’ x * 1' â‰¡ x 
  *-assoc : âˆ€ x y z â†’ x * (y * z) â‰¡ x * y * z
  *-comm : âˆ€ x y â†’ x * y â‰¡ y * x
  distribË¡ : âˆ€ x y z â†’ x * (y + z) â‰¡ x * y + x * z
  distribÊ³ : âˆ€ x y z â†’ (y + z) * x â‰¡ y * x + z * x
  zeroË¡ : âˆ€ x â†’ 0' * x â‰¡ 0'
  zeroÊ³ : âˆ€ x â†’ x * 0' â‰¡ 0'

-- Infinitesimal object are zero locus of polynomials on infinitesimal variables

_^_ : Line â†’ â„• â†’ Line
x ^ zero = 1'
x ^ (suc n) = x ^ n

data ğŸ™ : Set where
  âˆ— : ğŸ™

e : ğŸ™ â†’ Line
e âˆ— = 0'

Line^ : â„• â†’ Set
Line^ zero = ğŸ™
Line^ (suc n) = Line Ã— Line^ n

_^^_ : Set â†’ â„• â†’ Set
X ^^ zero = ğŸ™
X ^^ (suc n) = X Ã— X ^^ n

â„•_ : â„• â†’ Set
â„•_ n = Î£ â„• Î» m â†’ m < n

Ï€ : {n : â„•} {X : Set}{z : X} â†’ (k : â„•_ n) â†’ (x : X ^^ n) â†’ X
Ï€ {n = zero} {z = z} m x = z
Ï€ {n = (suc n)} m x = projâ‚ x

D : â„• â†’ Set
D n = Î£ Line Î» x â†’ x ^ n â‰¡ 0'

D[_] : â„• â†’ Set
D[ n ] = Î£ (Line ^^ n) Î» x â†’ âˆ€ {i j : â„•_ n} â†’ (Ï€ {n} {Line} {0'} i x) * (Ï€ {n} {Line} {0'} j x) â‰¡ 0'

-- KL axiom for the infinitesimal interval

Î¹ : {n : â„•} â†’ D n â†’ Line
Î¹ (x , p) = x

canonical-map : Line^ 2 â†’ (D 1 â†’ Line)
canonical-map (x , (y , _)) = Î» Îµ â†’ x + (y * (Î¹ {1} Îµ))

postulate
  KL-axiom : isIso canonical-map

fundamental-canonical-map : âˆ€ {n} â†’ Line^ (suc n) â†’ (D n â†’ Line)
fundamental-canonical-map {n = zero} (x , y) = Î» Îµ â†’ x -- Î» Îµ â†’ x + (y * (Î¹ {n} Îµ))
fundamental-canonical-map {n = suc n} (x , y) = Î» Îµ â†’ x + (fundamental-canonical-map {n} y Îµ * (Î¹ {suc n} Îµ)) -- Î» Îµ â†’ x + (y * (Î¹ {n} Îµ))

postulate
  fundamental-KL-axiom : âˆ€ {n} â†’ isIso (fundamental-canonical-map {n})
  
Poly : âˆ€ {n} â†’ Set
Poly {n} = Line ^^ n â†’ Line

locus : âˆ€ {n} â†’ Poly {n} â†’ Line ^^ n â†’ Set
locus {n} p = Î» x â†’ p x â‰¡ 0'

Locus : âˆ€ {n} â†’ Poly {n} â†’ Set
Locus {n} p = Î£ (Line ^^ n) (locus p)

nil-poly : âˆ€ {n} â†’ (m : â„• ^^ n) â†’ Poly {n}
nil-poly {n = zero}  m x = 0'
nil-poly {suc n} (r , s) (x , y) = (x ^ r) * (nil-poly {n} s y)

inf-obj : âˆ€ {n m} â†’ (s : â„• ^^ n) â†’ (P : (Poly {n}) ^^ m ) â†’ Set
inf-obj {n = zero} {m = zero} s P = ğŸ™ -- 0'
inf-obj {n = zero} {m = (suc m)} s P = ğŸ™ -- 0'
inf-obj {n = (suc n)} {m = zero} (s , r) P = Î£ Line Î» x â†’ inf-obj {n} {zero} r P Ã— (nil-poly {1} (s , âˆ—) (x , âˆ—) â‰¡ 0')
inf-obj {n = (suc n)} {m = (suc m)} s (p , q) = Î£ (Line ^^ (suc n)) Î» x â†’ (inf-obj {suc n} {m} s q) Ã— (p x â‰¡ 0')

satisfy-poly-system : âˆ€ {n m} â†’ (Poly {n}) ^^ m â†’ Line ^^ n â†’ Set
satisfy-poly-system {zero} {zero} S x = ğŸ™
satisfy-poly-system {suc n} {zero} S x = ğŸ™
satisfy-poly-system {n} {suc m} (p , S) x = (p x â‰¡ 0') Ã— satisfy-poly-system {n} {m} S x

satisfy-poly-system-compwise : âˆ€ {n} â†’ (Poly {1}) ^^ n â†’ Line ^^ n â†’ Set
satisfy-poly-system-compwise {zero} S x = ğŸ™
satisfy-poly-system-compwise {suc n} (p , S) (x , X) = (p ((x , âˆ—)) â‰¡ 0') Ã— satisfy-poly-system-compwise {n} S X

--free-term : âˆ€ {n} â†’ â„• ^^ n â†’ Line ^^ n â†’ Line
--free-term {zero} I x = 0'
--free-term {suc n} (k , I) (x , Y) = (x ^ k) * free-term I Y

--satisfy-nilpotency : âˆ€ {n} â†’ â„• ^^ n â†’ Line ^^ n â†’ Set
--satisfy-nilpotency {n} I x = free-term I x â‰¡ 0'

nilpotency-system : âˆ€ {m} â†’ (â„• ^^ m) â†’ Poly {1} ^^ m
nilpotency-system {zero} k = âˆ—
nilpotency-system {suc m} (k , I) =  (Î» x â†’ (projâ‚ x) ^ k) , nilpotency-system I

satisfy-nilpotency : âˆ€ {n} â†’ (I : â„• ^^ n) â†’ Line ^^ n â†’ Set
satisfy-nilpotency I x = satisfy-poly-system-compwise (nilpotency-system I) x

-- General infinitesimal objects InfObj as subsets of R^n generated by polynomials and nilpotency conditions

InfObj : âˆ€ {n m} â†’ (I : â„• ^^ n) â†’ (P : (Poly {n}) ^^ m ) â†’ Set
InfObj {n} {m} I P = Î£ (Line ^^ n) Î» x â†’ (satisfy-poly-system P x) Ã— satisfy-nilpotency I x



--inf-obj-as-subset : âˆ€ {n m}{s :  â„• ^^ n}{P : (Poly {n}) ^^ m } â†’ (C : inf-obj {n} {m} s P) â†’ Set
--inf-obj-as-subset {n} C = Î£ {!Line ^^ zero!} {!!} 


--general-canonical-map : âˆ€ {n m}{s :  â„• ^^ n}{P : (Poly {n}) ^^ m }{C : inf-obj {n} {m} s P} â†’ Line^ (suc n) â†’ (D n â†’ Line)
--general-canonical-map {n = zero} (x , y) = Î» Îµ â†’ x -- Î» Îµ â†’ x + (y * (Î¹ {n} Îµ))
--general-canonical-map {n = suc n} (x , y) = Î» Îµ â†’ x + (fundamental-canonical-map {n} y Îµ * (Î¹ {suc n} Îµ)) -- Î» Îµ â†’ x + (y * (Î¹ {n} Îµ))


